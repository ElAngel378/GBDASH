#include <gb/gb.h>
#include <stdint.h>
#include "logo.h"
#include "menu.h"
#include "menuscreen.h"
#include "register.h"

unsigned char blank[] = {
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    
};
unsigned char logo[] =
{
  1, 4, 7,10,13, 0,17,18,21,24,27,30,33,36,39,42,
  2, 5, 8,11,14, 0, 0,19,22,25,28,31,34,37,40,43,
  3, 6, 9,12,15, 0, 0,20,23,26,29,32,35,38,41,44
};


unsigned char playbutton[] =
{
  46, 50, 54, 58,
  47, 51, 55, 59,
  48, 52, 56, 60,
  49, 53, 57, 61,
};

unsigned char soundbtn[] =
{
  62, 64,
  63, 65
};


static void waitforframes(char frames) {
    while (frames > 0) {
        frames--;
        wait_vbl_done();
    }
}

const unsigned char stages[] = {
    0b00000000,
    0b01010100,
    0b10100100,
    0b11100100
};


uint8_t stage = 0;


void pal(void) {
    if (LY_REG == 48) {
        BGP_REG = stages[stage];
        LYC_REG = 0;
    } else {
        BGP_REG = 0b11100100;
        LYC_REG = 48;
    }
}

void fade(void (*callback)(void)) {
    waitforframes(5);
    BGP_REG = 0b11100101;
    waitforframes(5);
    BGP_REG = 0b11101010;
    waitforframes(5);
    BGP_REG = 0b11111111;
    if (callback) {callback();}
    waitforframes(5);
    BGP_REG = 0b11101010;
    waitforframes(5);
    BGP_REG = 0b11100101;
    waitforframes(5);
    BGP_REG = 0b11100100;
}

static void setup(void) {
    stopall();
    set_bkg_data(1,44,Logoimg);
    set_win_data(45,23,menu);
    set_bkg_tiles(0,0,32,32,blank);
    set_bkg_tiles(2,2,16,3,logo);
    BGP_REG = 0b11100100;
    SCX_REG = 0;
    SCY_REG = 64;
    HIDE_SPRITES;
    play(0);
}

void domenu(void) {

    fade(setup);
    scroll_bkg(0,64);
    SHOW_BKG;

    
    char sc = 0;

    while (SCY_REG > 0)
    {
        sc++;
        SCY_REG -= sc;
        if ((char)SCY_REG < 0) {
            sc *= -1;
            sc += 3;
            SCY_REG = 1;
        }
        wait_vbl_done();
    }

    STAT_REG |= 0x40;
    LYC_REG = 48;
    add_LCD(pal);
    set_interrupts(VBL_IFLAG | LCD_IFLAG | TIM_IFLAG);
    
    waitforframes(10);
    set_bkg_tiles(8,7,4,4,playbutton);
    set_bkg_tiles(9,13,2,2,soundbtn);
    stage = 1;
    wait_vbl_done();
    waitforframes(10);
    stage = 2;
    wait_vbl_done();
    waitforframes(10);
    stage = 3;
    wait_vbl_done();
    waitforframes(10);
    remove_LCD(pal);
}